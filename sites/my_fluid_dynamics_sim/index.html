<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluid Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gpu.js/2.10.0/gpu-browser.min.js"></script>
    <style>
        canvas {
            display: block;
            margin: 0 auto;
            background-color: #000;
        }
    </style>
</head>
<body>
    <canvas id="simulationCanvas" width="512" height="512"></canvas>
    <script>
        const canvas = document.getElementById('simulationCanvas');
        const gpu = new GPU({ canvas: canvas, mode: 'gpu' });

        // Grid size
        const size = 512;

        // Initialize fluid velocity field and density field
        let velocityX = new Float32Array(size * size).fill(0);
        let velocityY = new Float32Array(size * size).fill(0);
        let density = new Float32Array(size * size).fill(0);

        // Define GPU functions
        const advect = gpu.createKernel(function (velX, velY) {
            const dt = 0.1;  // Time step
            const i = this.thread.x;
            const j = this.thread.y;
            const posX = i - dt * velX[i + j * this.constants.size];
            const posY = j - dt * velY[i + j * this.constants.size];
            const x0 = Math.floor(posX), x1 = x0 + 1;
            const y0 = Math.floor(posY), y1 = y0 + 1;
            if (x0 >= 0 && x1 < this.constants.size && y0 >= 0 && y1 < this.constants.size) {
                const s1 = posX - x0, s0 = 1 - s1;
                const t1 = posY - y0, t0 = 1 - t1;
                return s0 * (t0 * this.constants.density[x0 + y0 * this.constants.size] + t1 * this.constants.density[x0 + y1 * this.constants.size]) +
                       s1 * (t0 * this.constants.density[x1 + y0 * this.constants.size] + t1 * this.constants.density[x1 + y1 * this.constants.size]);
            }
            return 0;
        }).setOutput([size, size]).setConstants({ size: size, density: density });

        const draw = gpu.createKernel(function (density) {
            const value = density[this.thread.x + this.thread.y * this.constants.size];
            this.color(value, value, value, 1);
        }).setOutput([size, size]).setGraphical(true).setConstants({ size: size });

        function step() {
            // Advection step
            density = advect(velocityX, velocityY);

            // Drawing step
            draw(density);

            requestAnimationFrame(step);
        }

        // Start the simulation
        step();
    </script>
</body>
</html>
